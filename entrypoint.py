#!/usr/bin/env python3
import argparse
import json
import requests
import os
parser = argparse.ArgumentParser(description="Parse the report file")
parser.add_argument("report_file", type=str, help="a name of the report file")
args = parser.parse_args()
github_repository = os.environ['GITHUB_REPOSITORY']
url = 'https://api.github.com/repos/{}/issues'.format(github_repository)
token = os.environ['TOKEN']
headers = { 'Authorization': 'token {}'.format(token),
            'Accept': 'application/vnd.github.v3+json' }
try:
  with open(args.report_file) as f:
    data = json.load(f)
    for vulnerability in data['vulnerabilities']:
      title = '{} {}'.format(vulnerability['title'], vulnerability['id'])
      payload = { 'title': title,
                  'body': vulnerability['description'],
                  'labels': ['Snyk'] }
      r = requests.post(url, data=json.dumps(payload), headers=headers)
      print(r.status_code)
      print(r.json())
except:
  print("Can not find the report file!")
